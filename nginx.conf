worker_processes auto;
pid /run/nginx.pid;
error_log /var/log/nginx-error.log;

events {
  worker_connections 768;
}

http {
  sendfile on;
  tcp_nopush on;
  types_hash_max_size 2048;

  include /etc/nginx/mime.types;

  ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
  ssl_prefer_server_ciphers on;

  access_log /var/log/nginx-access.log combined;

  # Enable compression for text files.
  gzip on;
  gzip_min_length 1024;

  server {
      # Redirect localhost non-SSL.
      listen 80;
      server_name box localhost;
      return 301 https://$host$request_uri;
  }
  server {
      # Redirect non-SSL.
      listen 80;
      server_name nytspellingbeesolver.com www.nytspellingbeesolver.com beekey.buzz www.beekey.buzz;
      return 301 https://beekey.buzz$request_uri;
  }
  server {
      # Redirect old URL.
      listen 443 ssl;
      server_name nytspellingbeesolver.com www.nytspellingbeesolver.com;
      # SSL Configuration
      ssl_certificate     /etc/ssl/nytspellingbeesolver.com.cert.pem;
      ssl_certificate_key /etc/ssl/nytspellingbeesolver.com.key.pem;
      ssl_protocols TLSv1.2 TLSv1.3;
      ssl_ciphers HIGH:!aNULL:!MD5;
      ssl_prefer_server_ciphers on;
      return 301 https://beekey.buzz$request_uri;
  }
  server {
      # Redirect www domain.
      listen 443 ssl http2;
      server_name www.beekey.buzz;
      # SSL Configuration
      ssl_certificate     /etc/ssl/beekey.buzz.domain.cert.pem;
      ssl_certificate_key /etc/ssl/beekey.buzz.private.key.pem;
      ssl_protocols TLSv1.2 TLSv1.3;
      ssl_ciphers HIGH:!aNULL:!MD5;
      ssl_prefer_server_ciphers on;
      return 301 https://beekey.buzz$request_uri;
  }
  server {
      # Beekey and localhost.
      listen 443 ssl http2;
      server_name beekey.buzz box localhost;

      ssl_certificate     /etc/ssl/beekey.buzz.domain.cert.pem;
      ssl_certificate_key /etc/ssl/beekey.buzz.private.key.pem;
      ssl_protocols TLSv1.2 TLSv1.3;
      ssl_ciphers HIGH:!aNULL:!MD5;
      ssl_prefer_server_ciphers on;

      # Logging
      access_log /var/log/sbb-nginx-access.log combined;
      error_log  /var/log/sbb-nginx-error.log;

      # Root directory
      root /var/www/site/current;
      index index.html;
      autoindex off;

      error_page 400 403 404 500 502 503 /error/$status.html;
      location ~ ^/err/(400|403|404|500|502|503)\.html$ {
          internal;
      }
      location /health {
        access_log off;
        add_header 'Content-Type' 'text/plain';
        return 200 "OK\n";
      }
      location = /clue-archive/ { # no page number
        return 301 /clues/a;
      }
      location = /clue/ { # no clue text
        return 301 /clues/a;
      }
      location = /puzzle/ { # no puzzle date
        return 301 /puzzle/latest;
      }
      location = /puzzles/ { # no time period
        return 301 /puzzles/latest;
      }
      location = /clues/ { # no clue prefix
        return 301 /clues/a;
      }
      # Redirect /clue/<letter> to /clue/<letter>/1 with a 301 status code
      location ~ ^/clue/([a-zA-Z])$ {
          return 301 /clue/$1/1;
      }
      location /search {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        real_ip_header   X-Forwarded-For;
        real_ip_recursive on;
        proxy_connect_timeout 3s;
        proxy_send_timeout 10s;
        proxy_read_timeout 11s;
        send_timeout 10s;
      }
      location / {
        try_files $uri $uri/ =404;
  	    default_type text/html;
      }
      location /static/ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
      }

      # Security Headers
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header X-XSS-Protection "1; mode=block";
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
      #add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://www.googletagmanager.com; style-src 'self'; img-src 'self'; connect-src 'self'; frame-src https://www.google.com";
      add_header Referrer-Policy "strict-origin-when-cross-origin";
      add_header Permissions-Policy "geolocation=(), microphone=(), camera=()";
  }
}
